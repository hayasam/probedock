# Nginx web server.
web:
  image: nginx
  command: nginx
  links:
    - app
  ports:
    - "3001:80"
  volumes:
    - "{{ release_path }}/nginx.conf:/etc/nginx/nginx.conf:ro"
    - "{{ release_path }}/public:/var/lib/probedock/public"
  restart: always

# Application in production mode.
# The application will not serve assets.
app:
  image: probedock/probedock
  links:
    - db
    - cache
  volumes:
    - "{{ release_path }}/public:/usr/src/app/public"
  env_file:
    - .env
  environment:
    PROBEDOCK_LOG_TO_STDOUT: "1"
  restart: always

# Background job processing task.
job:
  image: probedock/probedock
  command: rake resque:work
  links:
    - db
    - cache
  environment:
    QUEUE: "*"
    INTERVAL: "2"
    TERM_CHILD: "1"
    PROBEDOCK_LOG_TO_STDOUT: "1"
  env_file:
    - .env
  restart: always

# PostgreSQL database.
db:
  image: postgres:9.4
  volumes:
    - "{{ release_path }}/db-init-scripts:/docker-entrypoint-initdb.d"
    - "{{ deploy_to }}/postgresql/data:/var/lib/postgresql/data"
  environment:
    POSTGRES_PASSWORD: {{ PROBEDOCK_POSTGRES_PASSWORD }}
    PROBEDOCK_DATABASE_NAME: {{ PROBEDOCK_DATABASE_NAME }}
    PROBEDOCK_DATABASE_USERNAME: {{ PROBEDOCK_DATABASE_USERNAME }}
    PROBEDOCK_DATABASE_PASSWORD: {{ PROBEDOCK_DATABASE_PASSWORD }}
  restart: always

# Redis in-memory database.
cache:
  image: redis:2.8
  command: redis-server --appendonly yes
  volumes:
    - "{{ deploy_to }}/redis/data:/data"
  restart: always

# Pre-compile application assets.
# This is meant to be run as a one-off task (with "run" instead of "up").
task:
  image: probedock/probedock
  command: rake -T
  links:
    - db
    - cache
  volumes:
    - "{{ release_path }}/public:/usr/src/app/public"
    - "{{ release_path }}/tmp:/usr/src/app/tmp"
  env_file:
    - .env
  restart: no
