# Nginx web server.
web:
  image: nginx
  command: nginx
  links:
    - app
  ports:
    - "3001:80"
  volumes:
    - "{{ deploy_to }}/docker/web/nginx.conf:/etc/nginx/nginx.conf:ro"
    - "{{ deploy_to }}/public:/var/lib/probe-dock/public"
  restart: always

# Application in production mode.
# The application will not serve assets.
app:
  image: probedock/probe-dock
  links:
    - db
    - cache
  volumes:
    - "{{ deploy_to }}/public:/usr/src/app/public"
  env_file:
    - .env
  restart: always

# Background job processing task.
job:
  image: probedock/probe-dock
  command: rake resque:work
  links:
    - db
    - cache
  environment:
    QUEUE: "*"
    INTERVAL: "2"
    TERM_CHILD: "1"
  env_file:
    - .env
  restart: always

# PostgreSQL database.
db:
  image: postgres:9.4
  volumes:
    - "{{ deploy_to }}/docker/db-init-scripts:/docker-entrypoint-initdb.d"
    - "{{ deploy_to }}/postgresql/data:/var/lib/postgresql/data"
  env_file:
    - .env
  restart: always

# Redis in-memory database.
cache:
  image: redis:2.8
  command: redis-server --appendonly yes
  volumes:
    - "{{ deploy_to }}/redis/data:/data"
  restart: always

# Pre-compile application assets.
# This is meant to be run as a one-off task (with "run" instead of "up").
task:
  image: probedock/probe-dock
  command: rake -T
  links:
    - db
    - cache
  volumes:
    - "{{ deploy_to }}/public:/usr/src/app/public"
    - "{{ deploy_to }}/tmp/cache:/usr/src/app/tmp/cache"
  env_file:
    - .env
  restart: no
